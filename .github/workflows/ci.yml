name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_call:

permissions:
  contents: read

env:
  CARGO_TERM_COLOR: always

jobs:
  # Rust core library tests
  rust:
    name: Rust
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Cache Rust
        uses: Swatinem/rust-cache@v2

      - name: Check formatting
        run: cargo fmt --all -- --check

      - name: Clippy
        run: cargo clippy --all-targets --all-features -- -D warnings

      - name: Build
        run: cargo build --release

      - name: Test
        run: cargo test --all-features

  # Generate test vectors (shared by other jobs via artifacts)
  test-vectors:
    name: Test Vectors
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust
        uses: Swatinem/rust-cache@v2

      - name: Generate test vectors
        run: cargo run -p generate-vectors -- all

      - name: Verify vectors exist
        run: |
          test -f test-vectors/valid/minimal.json
          test -f test-vectors/valid/demographics-full.json
          test -f test-vectors/valid/with-face.json
          test -f test-vectors/invalid/bad-base45.json
          test -f test-vectors/edge/unknown-fields.json

      - name: Upload test vectors
        uses: actions/upload-artifact@v4
        with:
          name: test-vectors
          path: test-vectors/
          retention-days: 1

  # Python SDK tests
  python:
    name: Python
    runs-on: ubuntu-latest
    needs: test-vectors
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true

      - name: Cache Rust
        uses: Swatinem/rust-cache@v2

      - name: Download test vectors
        uses: actions/download-artifact@v4
        with:
          name: test-vectors
          path: test-vectors/

      - name: Install test dependencies and build claim169
        working-directory: core/claim169-python
        run: |
          uv sync
          uv run maturin develop --release

      - name: Run Python tests
        working-directory: core/claim169-python
        run: uv run pytest tests/ -v

  # TypeScript SDK tests
  typescript:
    name: TypeScript
    runs-on: ubuntu-latest
    needs: test-vectors
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust
        uses: Swatinem/rust-cache@v2

      - name: Install wasm-pack
        uses: taiki-e/install-action@v2
        with:
          tool: wasm-pack@0.13.1

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: sdks/typescript/package-lock.json

      - name: Download test vectors
        uses: actions/download-artifact@v4
        with:
          name: test-vectors
          path: test-vectors/

      - name: Build WASM
        working-directory: sdks/typescript
        run: npm run build:wasm

      - name: Install dependencies
        working-directory: sdks/typescript
        run: npm ci

      - name: Build TypeScript
        working-directory: sdks/typescript
        run: npm run build:ts

      - name: Run TypeScript tests
        working-directory: sdks/typescript
        run: npm test

  # Kotlin SDK tests
  kotlin:
    name: Kotlin
    runs-on: ubuntu-latest
    needs: test-vectors
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust
        uses: Swatinem/rust-cache@v2

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
          cache: gradle
          cache-dependency-path: sdks/kotlin/**/build.gradle.kts

      - name: Download test vectors
        uses: actions/download-artifact@v4
        with:
          name: test-vectors
          path: test-vectors/

      - name: Sync test vectors for Kotlin
        run: rsync -a test-vectors/ sdks/kotlin/test-vectors/

      - name: Build native library
        run: cargo build -p claim169-jni

      - name: Run Kotlin tests
        working-directory: sdks/kotlin
        run: ./gradlew :claim169-core:test

  # Cross-language conformance tests
  conformance:
    name: Conformance
    runs-on: ubuntu-latest
    needs: [python, typescript, kotlin]
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust
        uses: Swatinem/rust-cache@v2

      - name: Install wasm-pack
        uses: taiki-e/install-action@v2
        with:
          tool: wasm-pack@0.13.1

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: sdks/typescript/package-lock.json

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
          cache: gradle
          cache-dependency-path: sdks/kotlin/**/build.gradle.kts

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true

      - name: Download test vectors
        uses: actions/download-artifact@v4
        with:
          name: test-vectors
          path: test-vectors/

      - name: Build Kotlin native library
        run: cargo build -p claim169-jni

      - name: Build Python SDK
        working-directory: core/claim169-python
        run: |
          uv sync
          uv run maturin build --release

      - name: Install Python SDK
        run: |
          python -m venv .venv
          source .venv/bin/activate
          # maturin can emit multiple compatible wheels (e.g. linux + manylinux).
          # Install exactly one wheel to avoid pip resolution conflicts.
          WHEEL="$(ls -1 target/wheels/claim169-*.whl | grep -m 1 -E 'manylinux' || true)"
          if [ -z "$WHEEL" ]; then
            WHEEL="$(ls -1 target/wheels/claim169-*.whl | head -n 1)"
          fi
          echo "Installing wheel: $WHEEL"
          pip install "$WHEEL"

      - name: Build TypeScript SDK
        working-directory: sdks/typescript
        run: |
          npm run build:wasm
          npm ci
          npm run build:ts

      - name: Run conformance tests
        run: |
          source .venv/bin/activate
          chmod +x scripts/conformance-test.sh
          ./scripts/conformance-test.sh

  # Test packaging (catches packaging issues before release)
  test-packaging:
    name: Test Packaging
    runs-on: ubuntu-latest
    needs: rust
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust
        uses: Swatinem/rust-cache@v2

      - name: Install wasm-pack
        uses: taiki-e/install-action@v2
        with:
          tool: wasm-pack@0.13.1

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: sdks/typescript/package-lock.json

      # Test Rust crate packaging
      - name: Test cargo package (dry-run)
        run: |
          cargo package -p claim169-core --allow-dirty
          echo "Rust crate packages successfully"

      # Test Python wheel build
      - name: Build Python wheel
        uses: PyO3/maturin-action@v1
        with:
          target: x86_64-unknown-linux-gnu
          manylinux: manylinux_2_28
          args: --release --out dist -m core/claim169-python/Cargo.toml

      - name: Test Python wheel installation
        run: |
          python -m venv test-venv
          source test-venv/bin/activate
          # Install exactly one wheel to avoid pip conflicts if multiple wheels exist.
          WHEEL="$(ls -1 dist/*.whl | grep -m 1 -E 'manylinux' || true)"
          if [ -z "$WHEEL" ]; then
            WHEEL="$(ls -1 dist/*.whl | head -n 1)"
          fi
          echo "Installing wheel: $WHEEL"
          pip install "$WHEEL"
          python -c "import claim169; print(f'Python SDK version: {claim169.version()}')"
          echo "Python wheel installs and imports successfully"

      # Test npm package build
      - name: Build npm package
        working-directory: sdks/typescript
        run: |
          npm run build:wasm
          # Create .npmignore to include wasm files (overrides wasm/.gitignore)
          touch wasm/.npmignore
          npm ci
          npm run build:ts
          npm pack

      - name: Test npm package structure
        run: |
          mkdir -p /tmp/npm-test
          cd /tmp/npm-test
          tar -xzf ${{ github.workspace }}/sdks/typescript/*.tgz
          # Verify essential files exist
          test -f package/dist/index.js || (echo "Missing dist/index.js" && exit 1)
          test -f package/dist/index.d.ts || (echo "Missing dist/index.d.ts" && exit 1)
          test -f package/wasm/claim169_wasm.js || (echo "Missing wasm/claim169_wasm.js" && exit 1)
          test -f package/wasm/claim169_wasm_bg.wasm || (echo "Missing wasm/claim169_wasm_bg.wasm" && exit 1)
          echo "npm package structure is correct"

      # Test Kotlin/Maven packaging
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
          cache: gradle
          cache-dependency-path: sdks/kotlin/**/build.gradle.kts

      - name: Build Kotlin native library
        run: cargo build -p claim169-jni

      - name: Test Maven publication (local)
        working-directory: sdks/kotlin
        run: |
          ./gradlew :claim169-core:publishToMavenLocal
          # Verify published artifacts
          GROUP_PATH="org/acn/claim169"
          LOCAL_REPO="$HOME/.m2/repository/$GROUP_PATH/claim169-core"
          VERSION=$(grep -m1 'version = ' build.gradle.kts | sed 's/.*"\(.*\)".*/\1/')
          test -f "$LOCAL_REPO/$VERSION/claim169-core-$VERSION.jar" || (echo "Missing JAR" && exit 1)
          test -f "$LOCAL_REPO/$VERSION/claim169-core-$VERSION.pom" || (echo "Missing POM" && exit 1)
          test -f "$LOCAL_REPO/$VERSION/claim169-core-$VERSION-sources.jar" || (echo "Missing sources JAR" && exit 1)
          echo "Maven packaging is correct"

  # Code coverage (only on push to main)
  coverage:
    name: Coverage
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    needs: [rust, test-vectors]
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: llvm-tools-preview

      - name: Cache Rust
        uses: Swatinem/rust-cache@v2

      - name: Install cargo-llvm-cov
        uses: taiki-e/install-action@cargo-llvm-cov

      - name: Install wasm-pack
        uses: taiki-e/install-action@v2
        with:
          tool: wasm-pack@0.13.1

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: sdks/typescript/package-lock.json

      - name: Install uv
        uses: astral-sh/setup-uv@v4
        with:
          enable-cache: true

      - name: Download test vectors
        uses: actions/download-artifact@v4
        with:
          name: test-vectors
          path: test-vectors/

      - name: Rust coverage
        run: cargo llvm-cov --all-features --workspace --lcov --output-path rust-lcov.info

      - name: Build Python SDK
        working-directory: core/claim169-python
        run: |
          uv sync
          uv run maturin develop --release

      - name: Python coverage
        working-directory: core/claim169-python
        run: uv run pytest tests/ --cov=claim169 --cov-report=xml:../../python-coverage.xml --cov-report=term

      - name: Build TypeScript SDK
        working-directory: sdks/typescript
        run: |
          npm run build:wasm
          npm ci
          npm run build:ts

      - name: TypeScript coverage
        working-directory: sdks/typescript
        run: npm run test:coverage

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./rust-lcov.info,./python-coverage.xml,./sdks/typescript/coverage/lcov.info
          flags: rust,python,typescript
          fail_ci_if_error: false
          verbose: true
