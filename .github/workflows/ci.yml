name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  CARGO_TERM_COLOR: always

jobs:
  # Rust core library tests
  rust:
    name: Rust
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Check formatting
        run: cargo fmt --all -- --check

      - name: Clippy
        run: cargo clippy --all-targets --all-features -- -D warnings

      - name: Build
        run: cargo build --release

      - name: Test
        run: cargo test --all-features

  # Generate test vectors
  test-vectors:
    name: Test Vectors
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-vectors-${{ hashFiles('**/Cargo.lock') }}

      - name: Generate test vectors
        run: cargo run -p generate-vectors -- all

      - name: Verify vectors exist
        run: |
          test -f test-vectors/valid/minimal.json
          test -f test-vectors/valid/demographics-full.json
          test -f test-vectors/valid/with-face.json
          test -f test-vectors/invalid/bad-base45.json
          test -f test-vectors/edge/unknown-fields.json

  # Python SDK tests
  python:
    name: Python
    runs-on: ubuntu-latest
    needs: rust
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-python-${{ hashFiles('**/Cargo.lock') }}

      - name: Install maturin
        run: pip install maturin

      - name: Generate test vectors
        run: cargo run -p generate-vectors -- all

      - name: Install test dependencies and build claim169
        working-directory: core/claim169-python
        run: |
          uv sync
          # Build and install in one step using maturin develop
          uv run maturin develop --release

      - name: Run Python tests
        working-directory: core/claim169-python
        run: uv run pytest tests/ -v

  # TypeScript SDK tests
  typescript:
    name: TypeScript
    runs-on: ubuntu-latest
    needs: rust
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install wasm-pack
        run: |
          if ! command -v wasm-pack &> /dev/null || [ "$(wasm-pack --version)" != "wasm-pack 0.13.1" ]; then
            cargo install wasm-pack@0.13.1 --locked
          fi

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-wasm-${{ hashFiles('**/Cargo.lock') }}

      - name: Generate test vectors
        run: cargo run -p generate-vectors -- all

      - name: Build WASM
        working-directory: sdks/typescript
        run: npm run build:wasm

      - name: Install dependencies
        working-directory: sdks/typescript
        run: npm ci

      - name: Build TypeScript
        working-directory: sdks/typescript
        run: npm run build:ts

      - name: Run TypeScript tests
        working-directory: sdks/typescript
        run: npm test

  # Cross-language conformance tests
  conformance:
    name: Conformance
    runs-on: ubuntu-latest
    needs: [python, typescript]
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install wasm-pack
        run: |
          if ! command -v wasm-pack &> /dev/null || [ "$(wasm-pack --version)" != "wasm-pack 0.13.1" ]; then
            cargo install wasm-pack@0.13.1 --locked
          fi

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Install maturin
        run: pip install maturin

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-conformance-${{ hashFiles('**/Cargo.lock') }}

      - name: Generate test vectors
        run: cargo run -p generate-vectors -- all

      - name: Build Python SDK
        working-directory: core/claim169-python
        run: maturin build --release

      - name: Install Python SDK
        run: |
          python -m venv .venv
          source .venv/bin/activate
          pip install target/wheels/claim169-*.whl

      - name: Build TypeScript SDK
        working-directory: sdks/typescript
        run: |
          npm run build:wasm
          npm ci
          npm run build:ts

      - name: Run conformance tests
        run: |
          source .venv/bin/activate
          chmod +x scripts/conformance-test.sh
          ./scripts/conformance-test.sh

  # Test packaging (catches packaging issues before release)
  test-packaging:
    name: Test Packaging
    runs-on: ubuntu-latest
    needs: rust
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install wasm-pack
        run: cargo install wasm-pack@0.13.1 --locked

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install maturin
        run: pip install maturin

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-packaging-${{ hashFiles('**/Cargo.lock') }}

      # Test Rust crate packaging
      - name: Test cargo package (dry-run)
        run: |
          cargo package -p claim169-core --allow-dirty
          echo "Rust crate packages successfully"

      # Test Python wheel build
      - name: Build Python wheel
        uses: PyO3/maturin-action@v1
        with:
          target: x86_64-unknown-linux-gnu
          manylinux: manylinux_2_28
          args: --release --out dist -m core/claim169-python/Cargo.toml

      - name: Test Python wheel installation
        run: |
          python -m venv test-venv
          source test-venv/bin/activate
          pip install dist/*.whl
          python -c "import claim169; print(f'Python SDK version: {claim169.version()}')"
          echo "Python wheel installs and imports successfully"

      # Test npm package build
      - name: Build npm package
        working-directory: sdks/typescript
        run: |
          npm run build:wasm
          # Create .npmignore to include wasm files (overrides wasm/.gitignore)
          touch wasm/.npmignore
          npm ci
          npm run build:ts
          npm pack

      - name: Test npm package structure
        run: |
          mkdir -p /tmp/npm-test
          cd /tmp/npm-test
          tar -xzf ${{ github.workspace }}/sdks/typescript/*.tgz
          # Verify essential files exist
          test -f package/dist/index.js || (echo "Missing dist/index.js" && exit 1)
          test -f package/dist/index.d.ts || (echo "Missing dist/index.d.ts" && exit 1)
          test -f package/wasm/claim169_wasm.js || (echo "Missing wasm/claim169_wasm.js" && exit 1)
          test -f package/wasm/claim169_wasm_bg.wasm || (echo "Missing wasm/claim169_wasm_bg.wasm" && exit 1)
          echo "npm package structure is correct"

  # Code coverage (only on push to main)
  coverage:
    name: Coverage
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    needs: rust
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: llvm-tools-preview

      - name: Install cargo-llvm-cov
        uses: taiki-e/install-action@cargo-llvm-cov

      - name: Install wasm-pack
        run: cargo install wasm-pack@0.13.1 --locked

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Install maturin
        run: pip install maturin

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-coverage-${{ hashFiles('**/Cargo.lock') }}

      - name: Generate test vectors
        run: cargo run -p generate-vectors -- all

      - name: Rust coverage
        run: cargo llvm-cov --all-features --workspace --lcov --output-path rust-lcov.info

      - name: Build Python SDK
        working-directory: core/claim169-python
        run: |
          uv sync
          uv run maturin develop --release

      - name: Python coverage
        working-directory: core/claim169-python
        run: uv run pytest tests/ --cov=claim169 --cov-report=xml:../../python-coverage.xml --cov-report=term

      - name: Build TypeScript SDK
        working-directory: sdks/typescript
        run: |
          npm run build:wasm
          npm ci
          npm run build:ts

      - name: TypeScript coverage
        working-directory: sdks/typescript
        run: npm run test:coverage

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./rust-lcov.info,./python-coverage.xml,./sdks/typescript/coverage/lcov.info
          flags: rust,python,typescript
          fail_ci_if_error: false
          verbose: true
