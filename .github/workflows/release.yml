# Release preparation workflow
#
# Triggered manually to prepare a new release:
# 1. Validates version format
# 2. Bumps versions across all packages
# 3. Generates changelog
# 4. Creates a release PR for review
#
# After the PR is merged, manually create and push a GPG-signed tag,
# which triggers the publish-release.yml workflow.

name: Prepare Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 0.2.0, 0.2.0-alpha)'
        required: true
        type: string
      dry_run:
        description: 'Dry run (skip PR creation)'
        required: false
        default: false
        type: boolean

permissions:
  contents: read

env:
  CARGO_TERM_COLOR: always

jobs:
  validate:
    name: Validate Release
    runs-on: ubuntu-latest
    outputs:
      is_prerelease: ${{ steps.check.outputs.is_prerelease }}
      version: ${{ inputs.version }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate version format
        id: check
        run: |
          VERSION="${{ inputs.version }}"

          # Validate semver format
          if ! [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.]+)?$ ]]; then
            echo "::error::Invalid version format: $VERSION"
            echo "Expected: X.Y.Z or X.Y.Z-prerelease (e.g., 1.0.0, 1.0.0-alpha)"
            exit 1
          fi

          # Check if prerelease
          if [[ "$VERSION" =~ -[a-zA-Z] ]]; then
            echo "is_prerelease=true" >> $GITHUB_OUTPUT
            echo "Version $VERSION is a pre-release"
          else
            echo "is_prerelease=false" >> $GITHUB_OUTPUT
            echo "Version $VERSION is a stable release"
          fi

      - name: Check tag does not exist
        run: |
          if git tag -l "v${{ inputs.version }}" | grep -q .; then
            echo "::error::Tag v${{ inputs.version }} already exists"
            exit 1
          fi

      - name: Check working directory is clean
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "::error::Working directory is not clean"
            git status
            exit 1
          fi

  prepare:
    name: Prepare Release
    runs-on: ubuntu-latest
    needs: validate
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install git-cliff
        run: cargo install git-cliff --locked

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Bump versions
        run: ./scripts/bump-version.sh ${{ inputs.version }}

      - name: Generate changelog
        run: |
          git-cliff --tag "v${{ inputs.version }}" -o CHANGELOG.md

      - name: Show changes
        run: |
          echo "=== Version changes ==="
          git diff --name-only

          echo ""
          echo "=== Changelog preview ==="
          head -100 CHANGELOG.md

      - name: Create release branch and PR
        if: ${{ !inputs.dry_run }}
        run: |
          BRANCH="release/v${{ inputs.version }}"

          git checkout -b "$BRANCH"
          git add -A
          git commit -m "chore(release): prepare v${{ inputs.version }}"
          git push -u origin "$BRANCH"

      - name: Create Pull Request
        if: ${{ !inputs.dry_run }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PRERELEASE_NOTE=""
          if [ "${{ needs.validate.outputs.is_prerelease }}" = "true" ]; then
            PRERELEASE_NOTE="
          > **Note**: This is a pre-release version. It will be published with appropriate tags (npm: \`alpha\`/\`beta\`, PyPI: pre-release).
          "
          fi

          gh pr create \
            --title "chore(release): v${{ inputs.version }}" \
            --body "## Release v${{ inputs.version }}
          ${PRERELEASE_NOTE}
          This PR was automatically generated by the release workflow.

          ### Changes
          - Version bumped in all packages (Cargo.toml, pyproject.toml, package.json)
          - Changelog updated

          ### After merging
          Create and push a GPG-signed tag to trigger publishing:
          \`\`\`bash
          git checkout main
          git pull
          git tag -s v${{ inputs.version }} -m \"Release v${{ inputs.version }}\"
          git push origin v${{ inputs.version }}
          \`\`\`

          ### Checklist
          - [ ] Changelog looks correct
          - [ ] Version bumps are correct in all files
          - [ ] CI passes" \
            --label "release"

      - name: Dry run summary
        if: ${{ inputs.dry_run }}
        run: |
          echo "=== DRY RUN COMPLETE ==="
          echo ""
          echo "Would have created PR with:"
          echo "  Branch: release/v${{ inputs.version }}"
          echo "  Title: chore(release): v${{ inputs.version }}"
          echo ""
          echo "Changed files:"
          git diff --name-only
